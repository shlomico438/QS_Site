{% extends "base.html" %}

{% block content %}
<style>
    .transcription-area {
        width: 90%; /* Wide for presenter view */
        max-width: 900px;
        margin: 20px auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        /* Start transparent so buttons don't jump, but take up space */
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    #transcript-window {
        height: 400px; /* Fixed height for stability */
        overflow-y: auto;
        background: #ffffff;
        padding: 30px;
        border-radius: 12px;
        border: 2px solid #eaee00;
        font-size: 1.6rem; /* Large, clear text */
        color: #2c3e50;
        line-height: 1.8;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        text-align: left;
    }

    .upload-zone {
        margin-top: 30px;
        padding-bottom: 50px;
    }

    .btn-primary {
        padding: 18px 50px;
        font-size: 1.2rem;
        cursor: pointer;
    }
</style>

<div class="main-container">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="QuickScribe Logo" style="width: 300px; margin-bottom: 20px;">

    <h1>Transcription made simple.</h1>
    <p class="subtitle">Precision AI transcription for high-context languages and noisy environments.</p>

    <div id="transcription-container" class="transcription-area">
        <h3 style="margin-bottom: 5px; color: #666; text-align: left;">Live Transcript</h3>
        <div id="transcript-window">
            </div>
    </div>

    <div class="upload-zone" id="upload-box">
        <input type="file" id="fileInput" hidden>
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
            Start Recording/Upload
        </button>
        <p id="upload-status" style="margin-top: 15px; font-weight: bold; min-height: 24px;"></p>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('fileInput');
    const statusTxt = document.getElementById('upload-status');
    const transcriptWindow = document.getElementById('transcript-window');
    const transcriptContainer = document.getElementById('transcription-container');

    let socket;
    const CHUNK_SIZE = 5 * 1024 * 1024;

    fileInput.addEventListener('change', async function() {
        const file = this.files[0];
        if (!file) return;

        const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
        const jobId = "job_" + Date.now();

        // Reveal the window smoothly
        transcriptContainer.style.opacity = '1';
        transcriptWindow.innerHTML = '<p style="color: #888;">Connecting to GPU...</p>';

        socket = io({ query: { jobId: jobId } });

        socket.on('new_transcription', (data) => {
            // Remove placeholder on first message
            if (transcriptWindow.querySelector('p')) transcriptWindow.innerHTML = "";

            const newEntry = document.createElement('span');
            newEntry.innerText = data.text + " ";
            transcriptWindow.appendChild(newEntry);
            transcriptWindow.scrollTop = transcriptWindow.scrollHeight;
        });

        statusTxt.innerText = "Starting upload...";
        statusTxt.style.color = "#007bff";

        for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
            const start = chunkIndex * CHUNK_SIZE;
            const end = Math.min(start + CHUNK_SIZE, file.size);
            const rawChunk = file.slice(start, end);

            const formData = new FormData();
            const s3Filename = `chunk_${String(chunkIndex).padStart(3, '0')}.bin`;

            formData.append('file', rawChunk, s3Filename);
            formData.append('jobId', jobId);
            formData.append('filename', s3Filename);

            try {
                const response = await fetch('/api/upload_streaming_chunk', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error("Upload failed");

                const percent = Math.round(((chunkIndex + 1) / totalChunks) * 100);
                statusTxt.innerText = `Uploading: ${percent}%`;

                if (percent === 100) {
                    statusTxt.innerText = "Upload Complete. Processing audio...";
                    statusTxt.style.color = "green";
                }
            } catch (error) {
                statusTxt.innerText = "Upload failed: " + error.message;
                statusTxt.style.color = "red";
                break;
            }
        }
    });
});
</script>
{% endblock %}