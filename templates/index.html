{% extends "base.html" %}

{% block content %}
<div class="main-container">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="width: 250px; margin-bottom: 20px;">

    <h1>Transcription made simple.</h1>
    <p class="subtitle">Precision AI transcription for high-context languages and noisy environments.</p>

    <div id="transcription-container" class="feature-box" style="display:none; text-align: left;">
        <h3>Live Output</h3>
        <div id="transcript-window" style="height: 300px; overflow-y: auto; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #ddd; font-family: monospace; line-height: 1.6;">
            <p style="color: #888;">Waiting for GPU to start transcribing...</p>
        </div>
    </div>

    <div class="feature-box upload-zone" id="upload-box">
        <input type="file" id="fileInput" hidden>
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Start Recording/Upload</button>
        <p id="upload-status"></p>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('fileInput');
    const statusTxt = document.getElementById('upload-status');
    const transcriptWindow = document.getElementById('transcript-window');
    const transcriptContainer = document.getElementById('transcription-container');

    let socket;
    const CHUNK_SIZE = 5 * 1024 * 1024;

    fileInput.addEventListener('change', async function() {
        const file = this.files[0];
        if (!file) return;

        const jobId = "job_" + Date.now();

        // 1. Show the transcription window
        transcriptContainer.style.display = 'block';
        transcriptWindow.innerHTML = ""; // Clear initial message

        // 2. Connect to WebSocket room for this specific job
        socket = io({ query: { jobId: jobId } });

        // 3. Listen for new text from the GPU
        socket.on('new_transcription', (data) => {
            console.log("Received text:", data.text);
            const newEntry = document.createElement('span');
            newEntry.innerText = data.text + " ";
            transcriptWindow.appendChild(newEntry);

            // Auto-scroll to bottom
            transcriptWindow.scrollTop = transcriptWindow.scrollHeight;
        });

        for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
            const start = chunkIndex * CHUNK_SIZE;
            const end = Math.min(start + CHUNK_SIZE, file.size);

            // Capture the raw binary slice without any modifications
            const rawChunk = file.slice(start, end);

            const formData = new FormData();
            // We use .bin to signify this is a raw fragment, not a complete media file
            const s3Filename = `chunk_${String(chunkIndex).padStart(3, '0')}.bin`;

            formData.append('file', rawChunk, s3Filename);
            formData.append('jobId', jobId);
            formData.append('filename', s3Filename);

            let progressInterval;
            if (chunkIndex === totalChunks - 1) {
                let fakePercent = 90;
                progressInterval = setInterval(() => {
                    if (fakePercent < 99) {
                        fakePercent++;
                        statusTxt.innerText = `Finalizing: ${fakePercent}% (Syncing to cloud...)`;
                    }
                }, 2000);
            }

            try {
                // Uploading to siteapp.py endpoint
                const response = await fetch('/api/upload_streaming_chunk', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "Upload failed");
                }

                if (chunkIndex < totalChunks - 1) {
                    const percent = Math.round(((chunkIndex + 1) / totalChunks) * 90);
                    statusTxt.innerText = `Uploading: ${percent}%`;
                } else {
                    if (progressInterval) clearInterval(progressInterval);
                    const result = await response.json();
                    statusTxt.innerText = "Success! " + result.message;
                    statusTxt.style.color = "green";
                }
            } catch (error) {
                if (progressInterval) clearInterval(progressInterval);
                statusTxt.innerText = "Upload failed: " + error.message;
                statusTxt.style.color = "red";
                break;
            }
        }
    });
});
</script>
{% endblock %}