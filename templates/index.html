{% extends "base.html" %}

{% block content %}
<div class="main-container">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="QuickScribe Logo" style="width: 350px; height: auto; margin-bottom: 20px;" class="logo">
    
    <h1>Transcription made simple.</h1>
    <p class="subtitle">Precision AI transcription for high-context languages and noisy environments.</p>

    <div class="feature-box upload-zone" id="drop-zone">
        <p>Drag & Drop audio files here</p>
        <span>or</span>
        <input type="file" id="fileInput" hidden>
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Browse Files</button>
        <p id="upload-status"></p>
    </div>

    <div class="feature-box zoom-zone">
        <p>Want automatic meeting notes?</p>
        <a href="/zoom/login" class="btn btn-secondary zoom-btn">
            Connect Zoom Account
        </a>
    </div>

    <div id="authModal" class="modal">
        <div class="modal-content">
            <h2>Welcome to QuickScribe</h2>
            <p>Subscribe for unlimited transcriptions and Zoom integration.</p>
            
            <form id="subscribeForm">
                <input type="text" placeholder="Full Name" required class="modal-input">
                <input type="email" placeholder="Email Address" required class="modal-input">
                <button type="submit" class="btn btn-primary">Subscribe Now</button>
            </form>

            <div class="social-auth">
                <button class="btn btn-google">Continue with Google</button>
                <button class="btn btn-apple">Continue with Apple</button>
            </div>

            <button id="guestBtn" class="btn btn-secondary">Continue as Guest (2 free credits)</button>
        </div>
    </div>
</div>

<script>

    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('authModal');
        const guestBtn = document.getElementById('guestBtn');
        const fileInput = document.getElementById('fileInput');
        const statusTxt = document.getElementById('upload-status');

        // 1. Show modal if it's the user's first time
        if (!localStorage.getItem('qs_user_type')) {
            modal.style.display = 'flex';
        }

        // 2. Handle Guest Button Click
        guestBtn.onclick = () => {
            localStorage.setItem('qs_user_type', 'guest');
            localStorage.setItem('qs_credits', '2');
            modal.style.display = 'none';
        };

		// 3. Handle File Upload with Credit Management
		fileInput.addEventListener('change', async function() {
			const userType = localStorage.getItem('qs_user_type');
			let credits = parseInt(localStorage.getItem('qs_guest_credits') || "0");

			// Check if guest has credits left BEFORE starting the upload
			if (userType === 'guest' && credits <= 0) {
				alert("Free limit reached! Please subscribe to continue.");
				document.getElementById('authModal').style.display = 'flex';
				return;
			}

			const file = this.files[0];
			if (!file) return;

			statusTxt.innerText = "Uploading to S3...";
			statusTxt.style.color = "blue";
			
			const formData = new FormData();
			formData.append('file', file);

			try {
				const response = await fetch('/api/upload', {
					method: 'POST',
					body: formData
				});
				
				const result = await response.json();
				
				if (response.ok) {
					statusTxt.innerText = "Success! File saved to S3.";
					statusTxt.style.color = "green";

					// Deduct and update credits only on successful upload
					if (userType === 'guest') {
						const newCredits = credits - 1;
						localStorage.setItem('qs_guest_credits', newCredits.toString());
						alert(`Upload successful! You have ${newCredits} free credits left.`);
						
						// If they just used their last credit, show the subscription modal
						if (newCredits <= 0) {
							setTimeout(() => {
								alert("You've used your last free credit. Join QuickScribe for unlimited access!");
								document.getElementById('authModal').style.display = 'flex';
							}, 1000);
						}
					}
				} else {
					statusTxt.innerText = "Error: " + (result.error || "Upload failed");
					statusTxt.style.color = "red";
				}
			} catch (error) {
				statusTxt.innerText = "Network error. Check your connection.";
				statusTxt.style.color = "red";
			}
		});
		// 2. Handle Guest Button Click
		guestBtn.onclick = () => {
			// This is the initialization step
			localStorage.setItem('qs_user_type', 'guest');
			localStorage.setItem('qs_guest_credits', '2'); // Give them exactly 2
			
			modal.style.display = 'none';
			alert("Welcome! You have 2 free transcription credits.");
		};
    });
</script>
{% endblock %}